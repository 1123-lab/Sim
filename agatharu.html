<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Simulation: Intro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .decision-btn, .action-btn {
            transition: background-color 0.3s, transform 0.2s;
        }
        .decision-btn:hover, .action-btn:hover {
            transform: translateY(-2px);
        }
        .decision-btn.selected {
            background-color: #b91c1c; /* Darker Red */
            color: white;
            cursor: default;
        }
        .decision-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        #consequence-box, #score-box, #next-phase-btn, #end-game-message {
            transition: opacity 0.5s, transform 0.5s;
        }
        .crew-icon {
            width: 24px;
            height: 24px;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
        }
        .crew-icon.alive {
            stroke: #000000; /* Black */
        }
        .crew-icon.unknown {
            stroke: #f59e0b; /* Amber/Yellow */
        }
        .crew-icon.deceased {
            stroke: #6b7280; /* Gray */
        }
        .cross {
            stroke: #ef4444; /* Red */
            stroke-width: 3;
            stroke-linecap: round;
            display: none; /* Hidden by default */
        }
        .crew-icon.deceased .cross {
            display: block; /* Shown when deceased */
        }
        #fullscreen-image-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .audio-btn {
            cursor: pointer;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 md:p-10">

        <!-- Start Page -->
        <div id="start-page" class="text-center space-y-8">
             <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ИНЦИДЕНТ НА БОРТУ ПЛАВГОСТИНИЦЫ 'АГАТА'</h1>
            <div class="bg-gray-100 p-4 rounded-lg text-left">
                <h2 class="text-xl font-bold text-gray-800 mb-2">ПРЕДЫСТОРИЯ</h2>
                <p class="text-gray-700">Симуляция, которую вы собираетесь начать, основана на реальном инциденте, произошедшем 20 лет назад на реальном судне с таким же количеством членов экипажа на борту, но ее детали изменены для целей данного учебного моделирования.</p>
            </div>
            <div class="bg-red-50 p-6 rounded-lg text-left">
                <h2 class="text-xl font-bold text-red-800 mb-2">ЗАДАЧА СИМУЛЯЦИИ</h2>
                <p class="text-red-800 leading-relaxed text-lg">
                    Вы — капитан судна «Агата». Ваша задача — пройти через девять фаз развивающейся чрезвычайной ситуации. На каждом этапе вам будет представлен сценарий и три возможных решения. Выберите действие, которое вы считаете наиболее эффективным. Ваша работа будет оцениваться на основе последствий ваших выборов. В итоговом счете будут учтены количество принятых правильных решений, общее затраченное время и, что наиболее важно, предотвращение жертв среди экипажа и посторонних лиц.
                </p>
            </div>
            <div class="flex justify-center">
                <button class="action-btn bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transform hover:scale-105 transition-transform flex items-center justify-center space-x-3" onclick="showVesselData()">
                    Данные о судне
                </button>
            </div>
        </div>

        <!-- Vessel Data Page -->
        <div id="vessel-data-page" class="hidden text-center space-y-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Данные о судне</h1>
            <div class="bg-red-50 p-6 rounded-lg text-left">
                <h2 class="text-xl font-bold text-red-800 mb-2">Ознакомление с судном</h2>
                <p class="text-red-800 leading-relaxed text-lg">
                    Перед началом симуляции, пожалуйста, ознакомьтесь с судном. Используйте ссылки ниже, чтобы просмотреть изображение «Агаты» и ее план общего расположения. Обратите особое внимание на планировку, особенно на расположение провизионной кладовой и сточного отсека, которые являются центральными в инциденте.
                </p>
            </div>
            <div class="flex flex-col items-center gap-4">
                <a href="#" onclick="event.preventDefault(); showVesselImage('https://raw.githubusercontent.com/1123-lab/Sim/main/Vessel%20Image.png');" class="text-lg text-blue-600 dark:text-blue-500 hover:underline cursor-pointer">
                    Изображение судна
                </a>
                <a href="#" onclick="event.preventDefault(); showVesselImage('https://raw.githubusercontent.com/1123-lab/Sim/main/GA%20plan.png');" class="text-lg text-blue-600 dark:text-blue-500 hover:underline cursor-pointer">
                    План общего расположения
                </a>
            </div>
            <div class="flex justify-center">
                <button class="action-btn bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transform hover:scale-105 transition-transform flex items-center justify-center space-x-3" onclick="startSimulation()">
                    <span class="text-lg">Начать симуляцию</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.118v3.764a1 1 0 001.555.832l3.197-1.882a1 1 0 000-1.664l-3.197-1.882z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        </div>

        <!-- Simulation Page -->
        <div id="simulation-page" class="hidden space-y-8">
            <!-- Header Section -->
            <div class="text-center border-t pt-6">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-800">Симуляция инцидента</h2>
                <p id="phase-title" class="text-2xl text-red-600 font-semibold mt-2"></p>
            </div>

            <!-- Scenario Section -->
            <div id="scenario-section">
                <h3 class="text-2xl font-semibold text-gray-700 mb-2 text-center">Описание сценария:</h3>
                <div id="scenario-audio-btn-container" class="flex justify-center mb-4"></div>
                <div class="bg-gray-50 border-l-4 border-red-500 p-4 rounded-r-lg">
                    <p id="scenario-text" class="text-lg text-gray-600 leading-relaxed"></p>
                </div>
            </div>

            <!-- Decision Section -->
            <div id="decision-section">
                <h3 id="decision-question" class="text-xl font-semibold text-gray-700 mb-4"></h3>
                <div id="decision-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
            </div>

            <!-- Consequence Section (Initially Hidden) -->
            <div id="consequence-box" class="hidden opacity-0 transform -translate-y-4">
                 <h3 class="text-2xl font-semibold text-red-800 mb-2 text-center">Последствия:</h3>
                 <div id="consequence-audio-btn-container" class="flex justify-center mb-4"></div>
                <div class="bg-orange-50 border-l-4 border-orange-500 p-5 rounded-r-lg shadow-inner">
                    <p id="consequence-text" class="text-lg text-gray-800 leading-relaxed"></p>
                </div>
            </div>
            
            <!-- Score Section (Initially Hidden) -->
            <div id="score-box" class="hidden opacity-0 transform -translate-y-4">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Счет:</h3>
                 <div class="bg-gray-50 border-l-4 border-gray-400 p-5 rounded-r-lg shadow-inner space-y-4">
                    <div class="flex justify-between items-center">
                        <p><strong>Правильные решения:</strong> <span id="correct-answer-status" class="font-bold text-green-600"></span></p>
                        <p><strong>Прошедшее время:</strong> <span id="time-lost" class="font-bold text-red-600"></span></p>
                    </div>
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center space-x-2">
                            <strong class="text-gray-700">Состояние экипажа:</strong>
                            <!-- MODIFICATION: Added flex-wrap and gap-1 for better mobile layout -->
                            <div id="headcount-visual" class="flex flex-wrap gap-1"></div>
                            <span id="headcount-text" class="font-bold text-gray-700"></span>
                        </div>
                         <p><strong>Посторонние жертвы:</strong> <span id="external-casualties-text" class="font-bold text-red-600">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Next Phase Button (Initially Hidden) -->
            <div id="next-phase-container" class="hidden w-full">
                 <button id="next-phase-btn" class="action-btn bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transform hover:scale-105 transition-transform flex items-center justify-center space-x-3">
                    <!-- Content set dynamically by JS -->
                </button>
            </div>
        </div>

        <!-- Final Score Page -->
        <div id="final-page" class="hidden text-center p-6 space-y-6">
            <h2 class="text-3xl font-bold text-green-600">Поздравляем, вы завершили симуляцию.</h2>
            <div class="flex justify-center" id="final-audio-btn-container"></div>

            <div class="bg-gray-100 p-6 rounded-lg shadow-inner">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Ваш итоговый счет:</h3>
                <div class="flex flex-col items-center space-y-4">
                    <!-- Row 1: Casualties -->
                    <div class="flex flex-col md:flex-row justify-center items-center md:space-x-8 space-y-4 md:space-y-0">
                        <div class="flex items-center space-x-2">
                            <strong class="text-lg">Итоговое состояние экипажа:</strong>
                            <!-- MODIFICATION: Added flex-wrap and gap-1 for better mobile layout -->
                            <div id="final-headcount-visual" class="flex flex-wrap gap-1"></div>
                            <span id="final-headcount-text" class="font-bold text-gray-700 text-xl"></span>
                        </div>
                         <p class="text-lg"><strong>Посторонние жертвы:</strong> <span id="final-external-casualties-text" class="font-bold text-red-600 text-xl"></span></p>
                    </div>
                    <!-- Row 2: Score -->
                    <div class="flex flex-col md:flex-row justify-center items-center md:space-x-8 space-y-4 md:space-y-0">
                        <p class="text-lg"><strong>Правильные решения:</strong> <span id="final-correct-decisions" class="font-bold text-green-600 text-xl"></span></p>
                        <p class="text-lg"><strong>Общее прошедшее время:</strong> <span id="final-time-lost" class="font-bold text-red-600 text-xl"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 text-left">
                 <p class="text-yellow-800">Не волнуйтесь - никто не пострадал и не погиб во время реального инцидента с пожаром в провизионной кладовой 20 лет назад.</p>
            </div>

            <p class="text-xl">Лучшее решение в любом инциденте — это его предотвращение.</p>
            <blockquote class="mt-4 italic text-xl border-l-4 border-gray-300 pl-4 text-gray-600">
                <p>"Мелочи — это то, что жизненно важно. Мелочи приводят к большим событиям."</p>
                <footer class="mt-1 text-sm">- Агата Кристи, *"10 негритят"*</footer>
            </blockquote>
             <button class="action-btn mt-6 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700" onclick="restartGame()">
                Начать симуляцию заново
            </button>
        </div>

    </div>

    <!-- Fullscreen Image Overlay -->
    <div id="fullscreen-image-overlay" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <button onclick="closeFullscreenImage()" class="absolute top-4 right-4 text-white text-4xl font-bold">&times;</button>
        <img id="fullscreen-image" src="" alt="Vessel illustration" class="max-w-[95vw] max-h-[95vh] object-contain rounded-lg">
    </div>

    <!-- Audio Players -->
    <audio id="audio-player"></audio>
    <audio id="sfx-player"></audio>


    <script>
        let currentPhaseIndex = 0;
        let totalTimeLost = 0;
        let totalDeceased = 0;
        let totalUnknown = 0;
        let totalExternalDeceased = 0;
        let correctDecisionsCount = 0;
        const totalCrew = 10;
        let currentAudioPlayer = document.getElementById('audio-player');
        let sfxPlayer = document.getElementById('sfx-player');
        let currentAudioBtn = null;

        const fullscreenOverlay = document.getElementById('fullscreen-image-overlay');
        const fullscreenImage = document.getElementById('fullscreen-image');

        const playIconHTML = `<div class="flex items-center justify-center space-x-3 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transform hover:scale-105 transition-transform"><span class="text-lg">Аудио</span><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.118v3.764a1 1 0 001.555.832l3.197-1.882a1 1 0 000-1.664l-3.197-1.882z" clip-rule="evenodd" /></svg></div>`;
        const pauseIconHTML = `<div class="flex items-center justify-center space-x-3 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transform hover:scale-105 transition-transform"><span class="text-lg">Пауза</span><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div>`;
        const playIconRedHTML = `<div class="flex items-center justify-center space-x-3 bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-800 transform hover:scale-105 transition-transform"><span class="text-lg">Аудио</span><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.118v3.764a1 1 0 001.555.832l3.197-1.882a1 1 0 000-1.664l-3.197-1.882z" clip-rule="evenodd" /></svg></div>`;
        const pauseIconRedHTML = `<div class="flex items-center justify-center space-x-3 bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-800 transform hover:scale-105 transition-transform"><span class="text-lg">Пауза</span><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></div>`;

        // Define sound effect URLs
        const safeSoundUrl = 'https://raw.githubusercontent.com/1123-lab/Sim/audio/p19.mp3';
        const dangerSoundUrl = 'https://raw.githubusercontent.com/1123-lab/Sim/audio/among1.mp3';

        const gamePhases = [
            { // Phase 1
                title: "Фаза 1: Предотвращение/Раннее обнаружение",
                correct: 'A',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/1.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario1rus.mp3",
                scenario: `"<strong>07:30, 15 июля | Астраханская верфь.</strong> Вы — капитан «Агаты», 50-метровой плавгостиницы с экипажем из 10 человек. Пассажиров на борту нет, так как судно стоит на кильблоках для 5-летнего планового докования; танки пусты, генераторы в ремонте, и судно работает от берегового питания с минимально необходимым оборудованием. В течение недели рабочие верфи проводили сварочные работы, заменяя коррозионный металл на переборках судна. Следующая их задача — сварщик должен работать на переборке сточного отсека, по другую сторону которой находится провизионная кладовая судна. Эта кладовая все еще заполнена горючими материалами, так как задача по освобождению провизионки несколько раз откладывалась и, наконец, была запланирована на сегодня."`,
                question: "Как капитан, каковы ваши утренние действия по наряду-допуску?",
                decisions: {
                    A: { text: "Связаться с руководителем верфи для подтверждения графика сварочных работ на сегодня и проверки наряда-допуска.", consequence: "Вы принимаете правильное процедурное решение, но руководитель признаёт, что ежедневный осмотр на месте ещё не завершен. Тем временем сварщик, желая закончить до наступления дневной жары, уже начал резку. Он не участвовал в первоначальном подписании наряда-допуска и предполагает, что все меры предосторожности, такие как вынос материалов из соседней провизионной кладовой, были выполнены вчера. Он не знает, что задача была отложена, и что он режет переборку, граничащую с помещением, полным горючих материалов. Пожар теперь неизбежен.", time: 7, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP1Arus.mp3" },
                    B: { text: "Связаться со старшим помощником для подтверждения графика сварочных работ на сегодня и проверки статуса наряда-допуска.", consequence: "Старший помощник подтверждает, что есть план по удалению материалов из провизионной кладовой сегодня в рамках мер предосторожности по наряду-допуску. Но он не знает, что сварщик пришел рано и направился прямо в сточный отсек, чтобы начать резку, желая закончить работу до того, как станет слишком жарко. Сварщик, не будучи полностью вовлечённым в процесс ежедневного подтверждения наряда-допуска, не знает, что пространство по другую сторону переборки еще не очищено. Пожар теперь неизбежен.", time: 5, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP1Brus.mp3" },
                    C: { text: "Поскольку наряд-допуск был выдан неделю назад, вы предполагаете, что он все еще действителен, и не перепроверяете его для сегодняшних работ.", consequence: "Вы предполагаете, что недельного наряда-допуска достаточно, пренебрегая требованием ежедневной перепроверки и осмотра на месте. Из-за этого вы не проверяете текущие условия. Сварщик пришел рано и направился прямо в сточный отсек, чтобы начать резку. Он не был непосредственно вовлечен в процесс оформления наряда-допуска и совершенно не подозревает, что провизионная кладовая по другую сторону его рабочего места все еще полна горючих материалов. Пожар теперь неизбежен.", time: 0, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP1Crus.mp3" }
                }
            },
            { // Phase 2
                title: "Фаза 2: Обнаружение пожара",
                correct: 'A',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/2.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario2rus.mp3",
                scenario: `"Сварщик верфи, войдя в сточный отсек через внутреннее помещение, устраивается и начинает резать переборку кислородно-ацетиленовым аппаратом. От высокой температуры воспламеняются бумажные полотенца, пластиковые канистры и другие материалы в соседней провизионной кладовой, что приводит к пожару. Вы находитесь на второй палубе, когда чувствуете запах дыма. Вы идете на запах и обнаруживаете что дым идет из крутого спуска вниз. Заглянув в него, вы видите слабое белое свечение далеко внизу. <strong>Доступ в провизионную кладовую в трюме осуществляется по очень крутым ступеням, спускающимся через узкий проход с резким поворотом перед дверью кладовой.</strong> Пожар начался. Вы знаете, что с таким количеством горючего материала огонь будет быстро распространяться, угрожая жилому блоку, если не действовать быстро."`,
                question: "Каковы ваши немедленные действия?",
                decisions: {
                    A: { text: "Бежать по жилым помещениям и палубе, крича 'ПОЖАР! ПОЖАР! ПОЖАР!'", consequence: "Вы принимаете правильное решение быстро поднять тревогу, но звук не распространяется эффективно по всему судну из-за шума верфи. Матрос, спящий в своей каюте на третьей палубе, далеко от суеты, остается не потревоженным, в то время как дым медленно начинает подниматься по лестничным пролетам и вентиляции.", time: 0.5, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP2Arus.mp3" },
                    B: { text: "Немедленно идти на мостик, чтобы включить сигнал общей тревоги на главной пожарной сигнализации судна.", consequence: "Вы бежите на мостик, чтобы включить общую тревогу, но обнаруживаете, что панель пожарной сигнализации не работает — она была отключена для проверки оборудования ГМССБ, а резервные батареи пожарной станции были сняты для обслуживания. Вы теряете драгоценное время, пытаясь использовать неработающую систему, пока огонь разгорается в трюме.", time: 1.5, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP2Brus.mp3" },
                    C: { text: "Схватить ближайший огнетушитель и начать спускаться по лестнице, чтобы по быстрому потушить огонь самому.", consequence: "Полагая, что это небольшой пожар, вы решаете справиться с ним самостоятельно. Вы хватаете огнетушитель и начинаете спускаться по крутым, узким ступеням. Неудобный поворот и наклон делают быстрое передвижение с оборудованием практически невозможным. Не дойдя и до половины, вы задерживаете дыхание от густого, едкого дыма, что заставляет вас с трудом отступить наверх. Вы потратили критическое время, надышались дымом, а пожар продолжает расти.", time: 4, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP2Crus.mp3" }
                }
            },
            { // Phase 3
                title: "Фаза 3: Проверка по списку",
                correct: 'A',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/3.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario3rus.mp3",
                scenario: `"После того как тревога была поднята голосом, члены экипажа хаотично собираются на месте сбора. Теперь отчетливо виден дым, поднимающийся из дверного проема второй палубы, ведущего в провизионку. Огонь постоянно разрастается, и вы знаете, что нужно действовать быстро, пока не загорелся весь жилой блок. Вы должны пересчитать весь персонал, прежде чем отправлять команду на борьбу с огнем."`,
                question: "Какой метод учета экипажа вы выберете?",
                decisions: {
                    A: { text: "Использовать систему Т-карточек на месте сбора для быстрой переклички.", consequence: "Вы следуете правильной процедуре, но доска с Т-карточками вводит в заблуждение. Она показывает одну карточку в положении 'ОТСУТСТВУЕТ' для ночного матроса, потому что его сменщик, дневной матрос, зная, что тот обычно уходит в их съемную квартиру в городе, переставил за него карточку. Физический подсчет людей на месте сбора совпадает с оставшимися карточками 'НА БОРТУ', поэтому вы делаете неверный вывод, что все в безопасности…", time: 3, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP3Arus.mp3" },
                    B: { text: "Использовать официальный список экипажа и попросить командный состав устно подтвердить наличие экипажа.", consequence: "Вы берете список экипажа  и называете имена. Когда вы называете ночного матроса, его начальник, второй помощник, поговорив с дневным матросом, сообщает, что ночной матрос 'как обычно, в городе на весь день'. Не имея причин сомневаться в докладе, вы отмечаете его как отсутствующего на судне. Спящий матрос на третьей палубе остается необнаруженным.", time: 6, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP3Brus.mp3" },
                    C: { text: "Пропустить формальную перекличку, чтобы сэкономить время и немедленно подготовить пожарную команду.", consequence: "Полагая, что быстрая реакция важнее процедуры, вы кричите: 'Все здесь?', и собравшийся экипаж кричит в ответ: 'Да!'. Формальная перекличка не проводится. Отсутствие ночного матроса остается совершенно незамеченным, пока вы спешите организовать пожарную атаку.", time: 0.5, deceased: 0, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP3Crus.mp3" }
                }
            },
            { // Phase 4
                title: "Фаза 4: Оповещение и связь",
                correct: 'B',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/4.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario4rus.mp3",
                scenario: `"Перекличка завершена, но с критической ошибкой. Вы считаете, что весь экипаж на месте. Однако вы не знаете, что отсутствующий ночной матрос на третьей палубе <strong class='text-red-700'>уже умер, надышавшись дымом во сне;</strong> под его кроватью позже найдут бутылку водки. Огонь постоянно разрастается, и вы должны действовать быстро, пока не загорелся весь жилой блок. Вы следуете списку оповещения и должны уведомить все стороны, но бухгалтер компании вовремя не пополнил баланс судового мобильного телефона, и у вас есть возможность сделать только <strong>один звонок</strong>."`,
                question: "Каков ваш первый приоритетный звонок?",
                decisions: {
                    A: { text: "Позвонить по экстренному номеру верфи.", consequence: "Вы звоните на верфь, они реагируют немедленно и отправляют своих людей, чтобы открыть береговую пожарную линию и подключить рукава. Они прибывают быстро, но в береговой линии недостаточное давление, и вода заканчивается, как только они заполняют рукав — лишь слабая струйка ржавой воды которая быстро иссякает.", time: 2, deceased: 1, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP4Arus.mp3" },
                    B: { text: "Позвонить назначенному лицу компании на берегу (DPA).", consequence: "Вы принимаете правильное процедурное решение, позвонив DPA, но он находится в другой стране. Он запускает официальную цепочку уведомлений: офис компании -> местный агент -> Астраханская верфь -> Городские службы. Реакция на инцидент управляется профессионально, но значительно задерживается. Тем временем рабочие верфи замечают дым и реагируют, но их береговая пожарная линия не имеет давления, производя лишь слабую струю ржавой воды, прежде чем выйти из строя.", time: 5, deceased: 1, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP4Brus.mp3" },
                    C: { text: "Позвонить капитану соседнего судна на кильблоках для немедленной помощи.", consequence: "Вы связываетесь с капитаном соседнего судна. Встревоженный чрезвычайной ситуацией, он соглашается отправить помощь, но предупреждает, что у него на борту минимальный экипаж и он может выделить только одного, но самого опытного человека. Он отправляет своего старшего помощника с дыхательным аппаратом и огнетушителем. Тем временем рабочие верфи замечают дым и реагируют, но их береговая пожарная линия не имеет давления, производя лишь слабую струю ржавой воды, прежде чем выйти из строя.", time: 1.5, deceased: 1, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP4Crus.mp3" }
                }
            },
            { // Phase 5
                title: "Фаза 5: Первые действия экипажа",
                correct: 'B',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/5.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario5rus.mp3",
                scenario: `"Весь доступный экипаж переместился с места сбора на вторую палубу, собравшись у входа в провизионную кладовую. Они кашляют от дыма, но готовы к борьбе. Ваш гнев на бесполезную пожарную линию верфи, которая произвела на свет лишь слабую ржавую струю, быстро сменяется новым неприятным открытием. Ваша пожарная команда, дневной матрос и боцман, после надевания снаряжения сообщают, что только один дыхательный аппарат имеет полные баллоны; остальные были отправлены на береговую станцию для перезарядки. Огонь в трюме постоянно разрастается, и вы должны действовать быстро."`,
                question: "Каков ваш немедленный приказ?",
                decisions: {
                    A: { text: "Разрешить матросу спуститься одному с единственным дыхательным аппаратом, чтобы быстро потушить пожар.", consequence: "Как раз когда ваш матрос собирается спускаться, прибывает старший помощник с соседнего судна со своим дыхательным аппаратом. Увидев вашего человека готовым, он говорит: 'Я пойду с ним'. Пройдя сложный проход, они входят в провизионную кладовую. Ваш матрос, желая действовать быстро, использует свой пенный огнетушитель и направляет струю в сторону свечения огня. <strong class='text-red-700'>Он попадает в находящуюся под напряжением расплавленную розетку и падает без сознания.</strong> Старпом другого судна, увидев яркую вспышку и падение матроса, бежит наверх и кричит: 'Отключите электричество! Вашего человека ударило током!' Психически травмированный увиденным, он говорит: 'С меня хватит' и с трудом возвращается на свое судно.", time: 3, deceased: 0, unknown: 1, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP5Arus.mp3" },
                    B: { text: "Удержать команду и послать матроса на другое судно, настояв на немедленной помощи их пожарной команды с дыхательными аппаратами.", consequence: "Вы принимаете правильное решение придерживаться системы 'buddy system', но вынуждены ждать подкрепления. Вскоре прибывает старший помощник с соседнего судна со своим дыхательным аппаратом. Он говорит: 'Хорошо, я здесь. Мне понадобится один из ваших, чтобы показать дорогу'. Ваш матрос присоединяется к нему, и они спускаются с двумя огнетушителями. Пройдя сложный проход, они входят в провизионную кладовую. Ваш матрос, желая проявить себя, использует свой пенный огнетушитель и направляет струю в сторону свечения огня. <strong class='text-red-700'>Он попадает в находящуюся под напряжением расплавленную розетку и падает без сознания.</strong> Старпом другого судна, увидев яркую вспышку и падение матроса, бежит наверх и кричит: 'Отключите электричество! Вашего человека ударило током!' Психически травмированный увиденным, он говорит: 'С меня хватит' и с трудом возвращается на свое судно.", time: 6, deceased: 0, unknown: 1, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP5Brus.mp3" },
                    C: { text: "Приказать матросу использовать единственный дыхательный аппарат только для разведки, чтобы оценить точное местоположение пожара, не вступая в борьбу с ним.", consequence: "Пока матрос готовится к разведке, прибывает старший помощник с соседнего судна с полностью заряженным дыхательным аппаратом. Он говорит: 'Нет времени на разведку, идем сейчас. Пусть ваш матрос покажет дорогу'. Ваш матрос присоединяется к нему, и они спускаются с двумя огнетушителями. Пройдя сложный проход, они входят в провизионную кладовую. Ваш матрос использует свой пенный огнетушитель и направляет струю на стену провизионной кладовой. <strong class='text-red-700'>Он попадает в находящуюся под напряжением расплавленную розетку и падает без сознания.</strong> Старпом другого судна, увидев яркую вспышку и падение матроса, бежит наверх и кричит: 'Отключите электричество! Вашего человека ударило током!' Психически травмированный увиденным, он говорит: 'С меня хватит' и с трудом возвращается на свое судно.", time: 3, deceased: 0, unknown: 1, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP5Crus.mp3" }
                }
            },
            { // Phase 6
                title: "Фаза 6: Отключение электроэнергии",
                correct: 'C',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/6.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario6rus.mp3",
                scenario: `"Отчаянные крики Старпома об ударе током вызывают нервную панику среди собравшегося экипажа. 2-й механик, чей лучший друг — матрос, лежащий без сознания в трюме, дрожит от смеси страха и ярости. Ваша единственная внешняя помощь отступила, огонь продолжает расти, и вы знаете, что должны немедленно принять решение об отключении электропитания судна, чтобы иметь хоть какой-то шанс спасти его."`,
                question: "Каков ваш немедленный приказ относительно электроэнергии?",
                decisions: {
                    A: { text: "Оставить электропитание включенным, так как достаточное освещение необходимо для любой попытки спасения.", consequence: "Вы колеблетесь, опасаясь, что полное отключение помешает спасательной операции. Однако старший механик, услышав крики об ударе током, игнорирует ваши колебания. Он берет дело в свои руки и, чтобы сэкономить время, отключает всё питание на судне. В сточном отсеке сварщик, недоумевающий, почему пламя его резака ослабевает, погружается в полную темноту. <strong class='text-red-700'>Пытаясь выбраться, он соскальзывает с незакрепленной деревянной лестницы, падает и ломает шею.</strong>", time: 1.5, deceased: 0, unknown: 0, externalDeceased: 1, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP6Arus.mp3" },
                    B: { text: "Приказать старшему механику немедленно отключить все электропитание на всем судне.", consequence: "Вы принимаете резкое решение о полном отключении. Старший механик, уже бегущий к щиту после криков, получает ваш приказ и немедленно отключает всё питание. Судно погружается во тьму. В сточном отсеке сварщик, недоумевающий, почему пламя его резака ослабевает, застигнут врасплох, когда его переносная лампа гаснет. <strong class='text-red-700'>Пытаясь выбраться в кромешной тьме, он соскальзывает с незакрепленной деревянной лестницы, падает и ломает шею.</strong>", time: 0.5, deceased: 0, unknown: 0, externalDeceased: 1, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP6Brus.mp3" },
                    C: { text: "Приказать старшему механику отключить питание только в секции провизионной кладовой.", consequence: "Вы принимаете правильное тактическое решение, но не успеваете договорить, как старший механик, услышав крики об ударе током, уже бежит к щиту. Чтобы сэкономить время и исключить любой возможный риск, он производит аварийное отключение, отключив всё судно. В сточном отсеке сварщик, недоумевающий, почему пламя его резака ослабевает, погружается в полную темноту. <strong class='text-red-700'>Пытаясь выбраться, он соскальзывает с незакрепленной деревянной лестницы, падает и ломает шею.</strong>", time: 1, deceased: 0, unknown: 0, externalDeceased: 1, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP6Crus.mp3" }
                }
            },
            { // Phase 7
                title: "Фаза 7: Отчаянная попытка спасения",
                correct: 'B',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/7.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario7rus.mp3",
                scenario: `"Судно в полной темноте; виден лишь ужасающий отблеск огня из провизионной кладовой. Вы не знаете о судьбе сварщика; все ваше внимание сосредоточено на матросе без сознания внизу в провизионном складе. Внутренний проход теперь полностью заблокирован густым дымом. В хаосе боцман кричит: 'Капитан, есть же другой путь! На главной палубе есть большой люк в кладовую' Вы знаете, что доступ к этому люку находится на главной палубе с внешней стороны, <strong>где узкий проход заставляет любого, кто его открывает, стоять спиной к леерам</strong>. Огонь разрастается, и вы должны торопиться."`,
                question: "Каково ваше решение?",
                decisions: {
                    A: { text: "Приказать экипажу немедленно открыть люк на главной палубе.", consequence: "Услышав ваш приказ, 2-й механик, чей лучший друг — матрос без сознания внизу, в отчаянии. Он хватает повара, и они лихорадочно откручивают люк. Открытие люка вызывает смертельную обратную тягу. Огонь поглотил большую часть кислорода в запечатанной провизионной кладовой, создав вакуум, из-за которого люк трудно открыть. В момент нарушения герметичности происходит мощный приток свежего воздуха, что приводит к воспламенению и взрыву перегретых материалов. <strong class='text-red-700'>Люк срывается силой взрыва, сбрасывая 2-го механика и повара за борт на бетон с высоты 5 метров. Матрос без сознания в трюме погибает в стене огня. Вторая вспышка устремляется вверх по внутреннему проходу. Старший и второй помощники оказываются в огне; их огнестойкие комбинезоны, изношенные от частых стирок, не обеспечивают защиты и мгновенно воспламеняются.</strong> Вы теряете 5 членов экипажа одновременно...", time: 1, deceased: 5, unknown: -1, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP7Arus.mp3" },
                    B: { text: "Вспомнив фильм 'Обратная тяга', вы приказываете всем держаться подальше от люка, сомневаясь в его безопасности.", consequence: "Вы принимаете правильное техническое решение, но на главной палубе 2-й механик, чей лучший друг — матрос без сознания внизу, в отчаянии. Он хватает повара, и они лихорадочно откручивают люк. Открытие люка вызывает смертельную обратную тягу. Огонь поглотил большую часть кислорода в запечатанной провизионной кладовой, создав вакуум, из-за которого люк трудно открыть. В момент нарушения герметичности происходит мощный приток свежего воздуха, что приводит к воспламенению и взрыву перегретых материалов. <strong class='text-red-700'>Люк срывается силой взрыва, сбрасывая 2-го механика и повара за борт на бетон с высоты 5 метров. Матрос без сознания в трюме погибает в стене огня. Вторая вспышка устремляется вверх по внутреннему проходу. Старший и второй помощники оказываются в огне; их огнестойкие комбинезоны, изношенные от частых стирок, не обеспечивают защиты и мгновенно воспламеняются.</strong> Вы теряете 5 членов экипажа одновременно...", time: 0.5, deceased: 5, unknown: -1, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP7Brus.mp3" },
                    C: { text: "Вы думаете, что ближайший путь для спасения матроса — все еще внутренний трап, поэтому вы говорите боцману надеть дыхательный аппарат, оставленный старпомом с другого судна, и спуститься вниз.", consequence: "Ваша попытка использовать внутренний трап тщетна. Пока боцман готовится надеть дыхательный аппарат, отчаявшийся 2-й механик, чей лучший друг — матрос без сознания внизу, хватает повара, и они лихорадочно откручивают люк. Открытие люка вызывает смертельную обратную тягу. Огонь поглотил большую часть кислорода в запечатанной провизионной кладовой, создав вакуум, из-за которого люк трудно открыть. В момент нарушения герметичности происходит мощный приток свежего воздуха, что приводит к воспламенению и взрыву перегретых материалов. <strong class='text-red-700'>Люк срывается силой взрыва, сбрасывая 2-го механика и повара за борт на бетон с высоты 5 метров. Матрос без сознания в трюме погибает в стене огня. Вторая вспышка устремляется вверх по внутреннему проходу. Старший и второй помощники оказываются в огне; их огнестойкие комбинезоны, изношенные от частых стирок, не обеспечивают защиты и мгновенно воспламеняются.</strong> Вы теряете 5 членов экипажа одновременно...", time: 1, deceased: 5, unknown: -1, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP7Crus.mp3" }
                }
            },
            { // Phase 8
                title: "Фаза 8: Прибытие пожарной машины",
                correct: 'B',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/8.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario8rus.mp3",
                scenario: `"Все в шоке от ужасных смертей. Снаружи рабочие верфи тщетно пытаются реанимировать упавших членов экипажа, прежде чем вызвать скорую помощь. Внутренние помещения судна теперь настолько задымлены густым токсичным дымом, что вы и немногие оставшиеся в живых вынуждены выйти на главную палубу. Вы слышите сирену — наконец-то прибыла городская пожарная машина. Однако водитель останавливается, заблокированный загроможденной территорией верфи, полной материалов и препятствий. Их пожарные рукава не могут дотянуться до судна."`,
                question: "Каково ваше решение?",
                decisions: {
                    A: { text: "Отправить оставшегося матроса в качестве сигнальщика для сопровождения машины.", consequence: "Вы приказываете последнему матросу направить пожарную машину. Рабочие верфи заняты двумя упавшими членами экипажа, так что больше некому. Матрос бежит к машине. <strong class='text-red-700'>В хаосе и спешке водитель пожарной машины сдает назад, не видя матроса в зеркале, и прижимает его к контейнеру, мгновенно убивая.</strong>", time: 1.5, deceased: 1, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP8Arus.mp3" },
                    B: { text: "Потребовать от верфи предоставить сигнальщика, так как это их территория и их ответственность.", consequence: "Вы правильно определяете, что ответственность лежит на верфи, но бригадир кричит в ответ, что все его люди заняты пострадавшими на земле. Видя задержку и чувствуя срочность, ваш последний матрос берет инициативу на себя и бежит, чтобы направить пожарную машину. <strong class='text-red-700'>В хаосе и спешке водитель пожарной машины сдает назад, не видя матроса в зеркале, и прижимает его к контейнеру, мгновенно убивая.</strong>", time: 4, deceased: 1, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP8Brus.mp3" },
                    C: { text: "Приказать своему экипажу начать расчищать путь для машины самостоятельно.", consequence: "Вы приказываете своему измотанному экипажу передвигать тяжелые кильблоки. Рабочие верфи заняты двумя упавшими членами экипажа, так что больше некому. Ваш последний матрос, видя, что это слишком медленно, решает сам показать путь машине.<strong class='text-red-700'>В хаосе и спешке водитель пожарной машины сдает назад, не видя матроса в зеркале, и прижимает его к контейнеру, мгновенно убивая.</strong>", time: 5, deceased: 1, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP8Crus.mp3" }
                }
            },
            { // Phase 9
                title: "Фаза 9: Финальный акт",
                correct: 'B',
                image: "https://raw.githubusercontent.com/1123-lab/Sim/main/9.png",
                scenarioAudio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/scenario9rus.mp3",
                scenario: `"Пожарная машина наконец на месте, но начальник пожарной части категорически отказывается отправлять своих людей на незнакомое судно. Он говорит: 'Мои люди не знают планировки. Мы не можем рисковать. Мы дадим вам рукав и всю воду, какая понадобится, но на этом всё'. У вас осталось всего 2 члена экипажа — это боцман и старший механик, все, включая вас, на главной палубе. К этому времени большинство материалов внутри сгорело, и огонь значительно ослаб. Жилой модуль все еще в опасности, но не горит. Огонь внизу продолжает тлеть, и вы знаете, что решение нужно принимать сейчас, чтобы спасти судно."`,
                question: "Каково ваше решение?",
                decisions: {
                    A: { text: "Отказаться от борьбы, решив, что позже можно будет обвинить пожарную бригаду в их отказе.", consequence: "Вы принимаете решение прекратить борьбу, планируя позже обвинить пожарную бригаду. Но боцман и старший механик, решают сделать гибель своих друзей не напрасной, и игнорируют ваш приказ. Они хватают тяжелый рукав у пожарной бригады. С одним полупустым дыхательным аппаратом они спускаются в горячую, задымленную тьму. Им удается потушить последние очаги огня. Они выбираются на палубу и падают без сил. <strong class='text-red-700'>В этом последнем героическом акте они надышались смертельным количеством токсичного дыма и паров от сгоревшего пластика и химикатов. Они умирают на палубе, спасая судно ценой своей жизни.</strong> И тогда остается только один. Один Вы, капитан, стоите в одиночестве среди тишины, дыма и обломков, единственный выживший из всего вашего экипажа.", time: 5, deceased: 2, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP9Arus.mp3" },
                    B: { text: "Приказать боцману и старшему механику взять рукав и потушить пожар.", consequence: "Вы принимаете правильное командное решение бороться с огнем, но с вашими последними двумя людьми. Измученные, но решительные, преследуемые памятью о погибших друзьях, они берут тяжелый рукав. С одним полупустым дыхательным аппаратом они спускаются в горячую, задымленную тьму. Им удается потушить последние очаги огня. Они выбираются на палубу и падают без сил. <strong class='text-red-700'>В этом последнем героическом акте они надышались смертельным количеством токсичного дыма и паров от сгоревшего пластика и химикатов. Они умирают на палубе, спасая судно ценой своей жизни.</strong> И тогда остается только один. Один Вы, капитан, стоите в одиночестве среди тишины, дыма и обломков, единственный выживший из всего вашего экипажа.", time: 3, deceased: 2, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP9Brus.mp3" },
                    C: { text: "Попытаться снова убедить начальника пожарной части, показав ему пожарный план судна.", consequence: "Вы тратите драгоценные минуты, споря с начальником пожарной части, который не изменит своего решения. Пока вы отвлечены, боцман и старший механик, зная, что время уходит, и преследуемые памятью о погибших друзьях, принимают решение за вас. Они хватают тяжелый рукав. С одним полупустым дыхательным аппаратом они спускаются в горячую, задымленную тьму. Им удается потушить последние очаги огня. Они выбираются на палубу и падают без сил. <strong class='text-red-700'>В этом последнем героическом акте они надышались смертельным количеством токсичного дыма и паров от сгоревшего пластика и химикатов. Они умирают на палубе, спасая судно ценой своей жизни.</strong> И тогда остается только один. Один Вы, капитан, стоите в одиночестве среди тишины, дыма и обломков, единственный выживший из всего вашего экипажа.", time: 4, deceased: 2, unknown: 0, externalDeceased: 0, audio: "https://github.com/1123-lab/Sim/raw/refs/heads/audio/consequenceP9Crus.mp3" }
                }
            }
        ];

        function renderHeadcount(containerId, textContainerId, deceasedCount, unknownCount, crewTotal = totalCrew) {
            const container = document.getElementById(containerId);
            const textContainer = document.getElementById(textContainerId);
            container.innerHTML = '';
            
            const aliveCount = crewTotal - deceasedCount - unknownCount;

            for (let i = 0; i < crewTotal; i++) {
                let iconClass = 'crew-icon';
                if (i < deceasedCount) {
                    iconClass += ' deceased';
                } else if (i < deceasedCount + unknownCount) {
                    iconClass += ' unknown';
                } else {
                    iconClass += ' alive';
                }
                
                const iconHTML = `
                    <svg class="${iconClass}" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="6" r="2.5"/>
                        <path d="M12 8.5V15M7 11l5-3 5 3M9 19l3-4 3 4"/>
                        <line class="cross" x1="4" y1="4" x2="20" y2="20"/>
                    </svg>
                `;
                container.innerHTML += iconHTML;
            }
            if (textContainer) {
                 let statusString = `(${aliveCount}/${crewTotal} Живы`;
                 if (unknownCount > 0) {
                     statusString += `, ${unknownCount} Неизвестно`;
                 }
                 statusString += ')';
                 textContainer.textContent = statusString;
            }
        }

        // --- UPDATED AUDIO LOGIC ---
        function toggleAudio(btn, audioSrc, isConsequence = false) {
            // Validate the audio source URL
            if (!audioSrc || !audioSrc.startsWith('http')) {
                console.warn('Skipping invalid audio source:', audioSrc);
                return;
            }

            // Check if the audio currently playing is the one we clicked
            const isCurrentlyPlayingThisAudio = !currentAudioPlayer.paused && currentAudioPlayer.currentSrc === audioSrc;

            if (isCurrentlyPlayingThisAudio) {
                // If it's playing, pause it.
                currentAudioPlayer.pause();
                btn.innerHTML = isConsequence ? playIconRedHTML : playIconHTML;
            } else {
                // If it's paused or a different audio file.
                
                // If we are switching to a new audio file...
                if (currentAudioPlayer.currentSrc !== audioSrc) {
                    // ...reset the button of the previously active audio, if there was one.
                    if (currentAudioBtn && currentAudioBtn !== btn) {
                        const wasConsequence = currentAudioBtn.getAttribute('data-consequence') === 'true';
                        currentAudioBtn.innerHTML = wasConsequence ? playIconRedHTML : playIconHTML;
                    }
                    // And load the new audio source.
                    currentAudioPlayer.src = audioSrc;
                }

                // Play the audio (either the new one or resuming the paused one).
                currentAudioPlayer.volume = 1.0;
                currentAudioPlayer.play().catch(e => console.error("Audio playback error:", e));
                
                // Update the button's appearance to "Pause" and track it as the current one.
                btn.innerHTML = isConsequence ? pauseIconRedHTML : pauseIconHTML;
                currentAudioBtn = btn;
                currentAudioBtn.setAttribute('data-consequence', isConsequence);
            }
        }
        
        currentAudioPlayer.onended = () => {
            if(currentAudioBtn) {
                const wasConsequence = currentAudioBtn.getAttribute('data-consequence') === 'true';
                currentAudioBtn.innerHTML = wasConsequence ? playIconRedHTML : playIconHTML;
                currentAudioBtn = null;
            }
        };

        function stopAudio() {
            currentAudioPlayer.pause();
            currentAudioPlayer.currentTime = 0;
            if (currentAudioBtn) {
                const wasConsequence = currentAudioBtn.getAttribute('data-consequence') === 'true';
                currentAudioBtn.innerHTML = wasConsequence ? playIconRedHTML : playIconHTML;
                currentAudioBtn = null;
            }
        }
        
        function playSoundEffect(isDangerous) {
            const soundUrl = isDangerous ? dangerSoundUrl : safeSoundUrl;
            if (soundUrl && soundUrl.startsWith('http')) {
                sfxPlayer.src = soundUrl;
                sfxPlayer.volume = 1.0;
                sfxPlayer.play().catch(e => console.error("SFX playback error:", e));
            }
        }

        function showConsequence(decisionKey) {
            stopAudio();
            const phase = gamePhases[currentPhaseIndex];
            const decision = phase.decisions[decisionKey];

            // --- Hide scenario and decisions ---
            document.getElementById('scenario-section').classList.add('hidden');
            document.getElementById('decision-section').classList.add('hidden');

            // --- Standard score and consequence logic ---
            if (decisionKey === phase.correct) {
                correctDecisionsCount++;
            }
            totalTimeLost += decision.time;
            totalDeceased += decision.deceased;
            totalUnknown += decision.unknown;
            totalExternalDeceased += decision.externalDeceased;

            document.getElementById('consequence-text').innerHTML = decision.consequence;
            document.getElementById('time-lost').textContent = `${totalTimeLost} минут`;
            document.getElementById('correct-answer-status').textContent = `${correctDecisionsCount} из ${gamePhases.length}`;
            renderHeadcount('headcount-visual', 'headcount-text', totalDeceased, totalUnknown);
            document.getElementById('external-casualties-text').textContent = `(${totalExternalDeceased})`;

            // --- Disable buttons ---
            document.querySelectorAll('.decision-btn').forEach(button => {
                button.disabled = true;
                if (button.id === `btn${decisionKey}`) {
                    button.classList.add('selected');
                }
            });
            
            // --- Image and Next Button Timer Logic ---
            const nextButtonContainer = document.getElementById('next-phase-container');
            const nextButton = document.getElementById('next-phase-btn');

            const showResults = () => {
                // Ensure other sections are hidden before showing results
                document.getElementById('scenario-section').classList.add('hidden');
                document.getElementById('decision-section').classList.add('hidden');

                const consequenceBox = document.getElementById('consequence-box');
                const scoreBox = document.getElementById('score-box');
                consequenceBox.classList.remove('hidden');
                scoreBox.classList.remove('hidden');
                setTimeout(() => {
                    consequenceBox.classList.remove('opacity-0', '-translate-y-4');
                    scoreBox.classList.remove('opacity-0', '-translate-y-4');
                }, 10);

                // Add consequence audio button
                const consequenceAudioBtnContainer = document.getElementById('consequence-audio-btn-container');
                consequenceAudioBtnContainer.innerHTML = '';
                if (decision.audio && decision.audio.startsWith('http')) {
                    const btn = document.createElement('span');
                    btn.className = 'audio-btn';
                    btn.innerHTML = playIconRedHTML;
                    btn.onclick = () => toggleAudio(btn, decision.audio, true);
                    consequenceAudioBtnContainer.appendChild(btn);
                }

                if (currentPhaseIndex < gamePhases.length - 1) {
                    nextButtonContainer.className = 'w-full flex justify-end'; // Align right
                    nextButton.innerHTML = `<span class="text-lg">Следующая фаза</span><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`;
                    nextButton.onclick = loadNextPhase;
                } else {
                    nextButtonContainer.className = 'w-full flex justify-center'; // Align center
                    nextButton.innerHTML = `<span class="text-lg">Итоговый счет</span><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2h8a2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>`;
                    nextButton.onclick = showFinalScore;
                }
                nextButtonContainer.classList.remove('hidden');
            };

            if (phase.image) {
                fullscreenImage.onload = () => {
                    // Play sound effect based on outcome
                    const isDangerous = decision.deceased > 0 || decision.externalDeceased > 0;
                    playSoundEffect(isDangerous);

                    fullscreenOverlay.classList.remove('hidden');
                    setTimeout(() => {
                        fullscreenOverlay.classList.add('hidden');
                        showResults();
                    }, 5000); // 5 seconds
                };
                fullscreenImage.onerror = () => {
                    console.error("Image failed to load:", phase.image);
                    showResults(); // Skip image if it fails to load
                };
                fullscreenImage.src = phase.image;

            } else {
                // If there's no image, just show the results immediately
                showResults();
            }
        }

        function showFinalScore() {
            stopAudio();
            document.getElementById('simulation-page').classList.add('hidden');
            const finalPage = document.getElementById('final-page');

            document.getElementById('final-correct-decisions').textContent = `${correctDecisionsCount} из ${gamePhases.length}`;
            document.getElementById('final-time-lost').textContent = `${totalTimeLost} минут`;
            renderHeadcount('final-headcount-visual', 'final-headcount-text', totalDeceased, totalUnknown);
            document.getElementById('final-external-casualties-text').textContent = `(${totalExternalDeceased})`;

            // Add final audio button
            const finalAudioBtnContainer = document.getElementById('final-audio-btn-container');
            finalAudioBtnContainer.innerHTML = ''; // Clear previous if any
            const finalAudioUrl = 'https://github.com/1123-lab/Sim/raw/refs/heads/audio/finalrus.mp3';
            if (finalAudioUrl) {
                const btn = document.createElement('span');
                btn.className = 'audio-btn';
                btn.innerHTML = playIconHTML;
                btn.onclick = () => toggleAudio(btn, finalAudioUrl);
                finalAudioBtnContainer.appendChild(btn);
            }

            finalPage.classList.remove('hidden');
        }

        function loadPhase(phaseIndex) {
            stopAudio();
            const phase = gamePhases[phaseIndex];
            document.getElementById('phase-title').textContent = phase.title;
            document.getElementById('scenario-text').innerHTML = phase.scenario;
            document.getElementById('decision-question').textContent = phase.question;

             // --- Make sure scenario and decisions are visible ---
            document.getElementById('scenario-section').classList.remove('hidden');
            document.getElementById('decision-section').classList.remove('hidden');

            // Add scenario audio button
            const scenarioAudioBtnContainer = document.getElementById('scenario-audio-btn-container');
            scenarioAudioBtnContainer.innerHTML = '';
             if (phase.scenarioAudio && phase.scenarioAudio.startsWith('http')) {
                const btn = document.createElement('span');
                btn.className = 'audio-btn';
                btn.innerHTML = playIconHTML;
                btn.onclick = () => toggleAudio(btn, phase.scenarioAudio);
                scenarioAudioBtnContainer.appendChild(btn);
            }

            const buttonsContainer = document.getElementById('decision-buttons');
            buttonsContainer.innerHTML = '';

            for (const key in phase.decisions) {
                const decision = phase.decisions[key];
                const button = document.createElement('button');
                button.id = `btn${key}`;
                button.className = "decision-btn w-full bg-red-600 text-white p-4 rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 text-left space-y-2";
                button.onclick = () => showConsequence(key);
                button.innerHTML = `<span class="font-bold text-lg">${key})</span><span class="block">${decision.text}</span>`;
                buttonsContainer.appendChild(button);
            }

            // Hide elements from previous phase
            document.getElementById('consequence-box').classList.add('hidden', 'opacity-0', '-translate-y-4');
            document.getElementById('score-box').classList.add('hidden', 'opacity-0', '-translate-y-4');
            document.getElementById('next-phase-container').classList.add('hidden');
            document.getElementById('final-page').classList.add('hidden');
        }

        function loadNextPhase() {
            currentPhaseIndex++;
            if (currentPhaseIndex < gamePhases.length) {
                loadPhase(currentPhaseIndex);
            } else {
                showFinalScore();
            }
        }

        function restartGame() {
            stopAudio();
            currentPhaseIndex = 0;
            totalTimeLost = 0;
            totalDeceased = 0;
            totalUnknown = 0;
            totalExternalDeceased = 0;
            correctDecisionsCount = 0;

            // Reset image handlers to prevent sound bug on restart
            fullscreenImage.onload = null;
            fullscreenImage.onerror = null;

            document.getElementById('simulation-page').classList.add('hidden');
            document.getElementById('final-page').classList.add('hidden');
            document.getElementById('vessel-data-page').classList.add('hidden');
            document.getElementById('start-page').classList.remove('hidden');
        }

        function showVesselData() {
            document.getElementById('start-page').classList.add('hidden');
            document.getElementById('vessel-data-page').classList.remove('hidden');
        }

        function showVesselImage(url) {
            sfxPlayer.pause();
            sfxPlayer.currentTime = 0;
            fullscreenImage.onload = null; // Clear any existing onload
            fullscreenImage.onerror = null; // Clear any existing onerror
            fullscreenImage.src = url;
            fullscreenOverlay.classList.remove('hidden');
        }

        function closeFullscreenImage() {
            fullscreenOverlay.classList.add('hidden');
            fullscreenImage.src = ''; // Clear src to stop loading
        }

        function startSimulation() {
            document.getElementById('vessel-data-page').classList.add('hidden');
            document.getElementById('simulation-page').classList.remove('hidden');
            loadPhase(0);
        }

        function preloadImages() {
            const imageUrls = [
                'https://raw.githubusercontent.com/1123-lab/Sim/main/Vessel%20Image.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/GA%20plan.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/1.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/2.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/3.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/4.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/5.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/6.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/7.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/8.png',
                'https://raw.githubusercontent.com/1123-lab/Sim/main/9.png'
            ];
            imageUrls.forEach(url => {
                const img = new Image();
                img.src = url;
            });
        }

        // Initial load
        window.onload = () => {
            preloadImages();
            document.getElementById('simulation-page').classList.add('hidden');
            document.getElementById('final-page').classList.add('hidden');
            document.getElementById('vessel-data-page').classList.add('hidden');
            document.getElementById('start-page').classList.remove('hidden');
        };
    </script>

</body>
</html>


